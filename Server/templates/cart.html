<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë°”êµ¬ë‹ˆ - Moble</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding-top: 80px; background-color: #f5f5f5; color: #1a1a1a; }
        header { background-color: #1a1a1a; color: white; position: fixed; top: 0; width: 100%; height: 60px; z-index: 1000; display:flex; align-items:center; padding: 0 20px; box-sizing:border-box;}
        .logo { font-weight: 800; font-size: 1.4em; cursor: pointer; color: white; text-decoration: none;}
        
        main { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; font-size: 24px; }

        /* ì¥ë°”êµ¬ë‹ˆ í…Œì´ë¸” */
        .cart-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cart-table th { background: #f9f9f9; padding: 15px; border-bottom: 1px solid #ddd; font-size: 14px; color: #555; }
        .cart-table td { padding: 15px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        .cart-item-info { display: flex; align-items: center; gap: 15px; text-align: left; }
        .cart-item-info img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .cart-item-title { font-weight: bold; font-size: 14px; color: #333; }
        .cart-item-brand { font-size: 12px; color: #888; }

        .qty-input { width: 40px; text-align: center; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-remove { background: white; border: 1px solid #ddd; color: #888; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-remove:hover { border-color: red; color: red; }

        .cart-summary { background: white; padding: 20px; margin-top: 20px; text-align: right; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .total-label { font-size: 16px; color: #555; margin-right: 10px; }
        .total-amount { font-size: 24px; font-weight: 800; color: #ff5722; }

        .btn-group { margin-top: 30px; display: flex; justify-content: space-between; }
        .btn-continue { background: #fff; border: 1px solid #333; color: #333; padding: 15px 30px; text-decoration: none; font-weight: bold; }
        
        /* ê²°ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-checkout { background: #ff5722; border: none; color: white; padding: 15px 50px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
        .btn-checkout:hover { background: #e64a19; }
        .btn-checkout i { font-size: 20px; }
    </style>
</head>
<body>
    <header>
        <a href="/" class="logo">Moble Shop</a>
    </header>

    <main>
        <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>
        
        <table class="cart-table">
            <thead>
                <tr>
                    <th style="width: 50%;">ìƒí’ˆì •ë³´</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>ìƒí’ˆê¸ˆì•¡</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="cart-list">
            </tbody>
        </table>

        <div class="cart-summary">
            <span class="total-label">ì´ ê²°ì œ ì˜ˆì • ê¸ˆì•¡</span>
            <span class="total-amount" id="total-price">0ì›</span>
        </div>

        <div class="btn-group">
            <a href="/" class="btn-continue">< ì‡¼í•‘ ê³„ì†í•˜ê¸°</a>
            <button class="btn-checkout" onclick="requestPayment()">
                <i class="fas fa-credit-card"></i> ê²°ì œí•˜ê¸°
            </button>
        </div>
    </main>

    <script>
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸°
        let cart = JSON.parse(localStorage.getItem('myCart')) || {};
        
        // [ìˆ˜ì • 1] Guest ì œê±° (ë¡œê·¸ì¸ ì•ˆí–ˆìœ¼ë©´ nullì´ ë˜ë„ë¡)
        let userId = localStorage.getItem('user_id'); 

        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
        });

        function renderCart() {
            const tbody = document.getElementById('cart-list');
            const totalEl = document.getElementById('total-price');
            tbody.innerHTML = '';
            let total = 0;

            const keys = Object.keys(cart);
            if (keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding:50px;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</td></tr>';
                totalEl.innerText = '0ì›';
                return;
            }

            keys.forEach(key => {
                const item = cart[key];
                const itemTotal = item.price * item.qty;
                total += itemTotal;

                const row = document.createElement('tr');
                
                // í™”ë©´ í‘œì‹œìš© ì´ë¦„ (nameì´ ì—†ìœ¼ë©´ product_name ì‚¬ìš©)
                const displayName = item.name || item.product_name || 'ìƒí’ˆëª… ì—†ìŒ';

                row.innerHTML = `
                    <td>
                        <div class="cart-item-info">
                            <img src="${item.image || 'https://via.placeholder.com/60'}" alt="img">
                            <div>
                                <div class="cart-item-brand">${item.brand || 'Brand'}</div>
                                <div class="cart-item-title">${displayName}</div>
                                <div style="font-size:13px; margin-top:4px;">${item.price.toLocaleString()}ì›</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="qty-input" value="${item.qty}" min="1" onchange="updateQty('${key}', this.value)">
                    </td>
                    <td style="font-weight:bold;">${itemTotal.toLocaleString()}ì›</td>
                    <td>
                        <button class="btn-remove" onclick="removeItem('${key}')"><i class="fas fa-times"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            totalEl.innerText = total.toLocaleString() + 'ì›';
        }

        function updateQty(key, newQty) {
            newQty = parseInt(newQty);
            if (newQty > 0) {
                cart[key].qty = newQty;
                localStorage.setItem('myCart', JSON.stringify(cart));
                renderCart();
            }
        }

        function removeItem(key) {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                delete cart[key];
                localStorage.setItem('myCart', JSON.stringify(cart));
                renderCart();
            }
        }

       // â˜…â˜…â˜… [í•µì‹¬ ìˆ˜ì •] ê²°ì œ ìš”ì²­ í•¨ìˆ˜ â˜…â˜…â˜…
        function requestPayment() {
            // [ìˆ˜ì • 1] ë¡œê·¸ì¸ ì²´í¬ ë¨¼ì € í•˜ê¸°!
            // ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ê²°ì œë¥¼ ë§‰ê³  ë¡œê·¸ì¸ ì°½ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
            if (!userId) { 
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!'); 
                location.href = '/login'; 
                return; 
            }

            const keys = Object.keys(cart);
            if (keys.length === 0) { alert('ê²°ì œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

            // 1. ì´ ê¸ˆì•¡ ë° ì£¼ë¬¸ ë°ì´í„° ìƒì„±
            let totalAmount = 0;
            let orderItems = [];
            
            keys.forEach(k => {
                let item = cart[k];
                totalAmount += item.price * item.qty;
                
                // [ìˆ˜ì • 2] ì„œë²„ê°€ ì›í•˜ëŠ” ì´ë¦„(product_name)ìœ¼ë¡œ ë³€í™˜í•´ì„œ ì €ì¥
                // (ê¸°ì¡´ì—ëŠ” item.nameë§Œ ìˆì–´ì„œ ì„œë²„ê°€ ì¸ì‹ì„ ëª» í–ˆìŠµë‹ˆë‹¤)
                orderItems.push({
                    product_name: item.name || item.product_name, // ì´ë¦„ ë§¤ì¹­
                    brand: item.brand,
                    price: item.price,
                    quantity: item.qty
                });
            });

            // 2. í¬íŠ¸ì›(ì•„ì„í¬íŠ¸) ì´ˆê¸°í™”
            var IMP = window.IMP; 
            IMP.init('imp50088740'); // íšŒì›ë‹˜ì˜ ì‹ë³„ì½”ë“œ

            // 3. ê²°ì œ ìš”ì²­ ì°½ ë„ìš°ê¸°
            IMP.request_pay({
                pg: "kakaopay",
                pay_method: "card",
                merchant_uid: "ORD-" + new Date().getTime(),
                name: orderItems[0].product_name + (orderItems.length > 1 ? ` ì™¸ ${orderItems.length-1}ê±´` : ""),
                amount: totalAmount,
                buyer_name: userId,
                buyer_tel: "010-1234-5678"
            }, function (rsp) {
                
                if (rsp.success) {
                    // 4. ê²°ì œ ì„±ê³µ ì‹œ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
                    fetch('/api/payment/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            user_id: userId,     // ë¡œê·¸ì¸í•œ ID ì „ì†¡
                            amount: rsp.paid_amount,
                            items: orderItems    // ì´ë¦„ ê³ ì¹œ ìƒí’ˆ ëª©ë¡ ì „ì†¡
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        localStorage.removeItem('myCart'); // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
                        location.href = '/order_history';  // ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™
                    })
                    .catch(err => {
                        alert('ì„œë²„ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + err);
                    });

                } else {
                    alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
                }
            });
        }
    </script>
</body>
</html>